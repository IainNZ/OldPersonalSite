<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="ie ie6" lang="en"> <![endif]-->
<!--[if IE 7 ]><html class="ie ie7" lang="en"> <![endif]-->
<!--[if IE 8 ]><html class="ie ie8" lang="en"> <![endif]-->
<!--[if (gte IE 9)|!(IE)]><!--><html lang="en"> <!--<![endif]-->
<head>

	<!-- Basic Page Needs
  ================================================== -->
	<meta charset="utf-8">
        <title>Implementing Second-order Cone Constraints in Gurobi - IainDunning.com</title>
	<meta name="description" content="Iain Dunning's personal website.">
	<meta name="author" content="Iain Dunning">

	<!-- Mobile Specific Metas
  ================================================== -->
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
  ================================================== -->
	<link rel="stylesheet" href="/css/base.css">
	<link rel="stylesheet" href="/css/skeleton.css">
        <link rel="stylesheet" href="/css/layout.css">
        <link rel="stylesheet" href="/css/syntax.css">


	<!--[if lt IE 9]>
		<script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->

	<!-- Favicons
	================================================== -->
	<link rel="shortcut icon" href="/images/favicon.ico">
	<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">

</head>
<body>

  <div class="container">
    <div class="sixteen columns">
      <h1 class="remove-bottom" style="margin-top: 40px; color: #6d97b7;">Iain Dunning</h1>
      <h5>
        Problem solver. Experiences, thoughts, and technical notes.
        <a href="/">More about me.</a>
        <a href="https://twitter.com/iaindunning">@iaindunning</a>
      </h5>
      <hr />
    </div>
    <div class="twelve columns">
      <h2>Implementing Second-order Cone Constraints in Gurobi</h2>
<p class="meta">Posted on 02 Dec 2012</p>

<div class="post">
<p>While working on a class project I came across the following constraint that arose from &quot;robustifying&quot; a linear constraint with an ellipsoidal uncertainty set:</p>

<div class="photo"><img src="/images/socpform1.png" alt=""><p class="caption"></p></div>

<p>where D is a diagonal matrix. In our case, <em>a</em> is the nominal value and the diagonal of D are the <em>&quot;a-hat&quot;</em> values that represent the small deviations we are robustifying against. This is a second-order cone constraint, so I needed to use <a href="http://en.wikipedia.org/wiki/Second-order_cone_programming">second-order cone programming</a> (SOCP). You can see from the Wikipedia page that this equation satisfies the form on that page. Gurobi 5.0 <a href="http://www.gurobi.com/products/gurobi-optimizer/what&#x27;s-new-in-v5.0">supports</a> quadratic constraints and second-order cone problems, so how do you implement them? There is no &quot;L2 norm&quot; function in the API, so we will have to modify the constraint into a different form. Your first guess might be to move the first term to the right hand side and square both sides</p>

<div class="photo"><img src="/images/socpform2.png" alt=""><p class="caption"></p></div>

<p>There is a problem here: both sides of this equation are convex, so this constraint doesn&#39;t obviously describe a convex set (try it in <a href="http://cvxr.com/cvx/">CVX</a>, it will be unhappy with you). I actually tried this first, and Gurobi reported that the constraint was not positive-semi-definite (PSD), which is true. Gurobi sees this as me trying to enter an invalid quadratic constraint, not as entering a SO constraint. So what is the right form?</p>

<p>The key is to look at documentation in the <a href="http://www.gurobi.com/documentation/5.0/reference-manual/node265">right place</a> (see second bullet point). However, what actually happened was that my friend <a href="http://www.mit.edu/%7Emlubin/">Miles Lubin</a> and I ended up doing it the hard way by looking at Gurobi&#39;s MATLAB interface and figuring out the form SOCP&#39;s must follow from that! We also had help from Chris Maes on the <a href="https://groups.google.com/d/topic/gurobi/UlCbvUjCs_w/discussion">Gurobi Google Group</a>, which confirmed our suspicions. In retrospect it seems obvious, from the definition of a second-order cone, but we sure did manage to confuse ourselves. To save someone else time in the future, if you have a constraint like this that has come from using an ellipsoidal uncertainty set, you need to do the following:</p>

<div class="photo"><img src="/images/socpform3.png" alt=""><p class="caption"></p></div>

<p>To demonstrate what this would look like in C++, I made the following code snippet:</p>

<div class="highlight"><pre><code class="cpp"><span class="c1">// Somewhere previously...</span>
<span class="c1">// GRBModel model = ...</span>
<span class="c1">// vector&lt;GRBVar&gt; x = ...</span>
<span class="c1">// vector&lt;double&gt; a = ...</span>
<span class="c1">// vector&lt;double&gt; ahat = ...</span>
<span class="c1">// int n = ...; double b = ...;</span>
    
<span class="c1">// New constraint 1</span>
<span class="n">GRBVar</span> <span class="n">t</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">addVar</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GRB_INFINITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GRB_CONTINUOUS</span><span class="p">);</span>
<span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
<span class="n">GRBLinExpr</span> <span class="n">teq</span><span class="p">;</span>
<span class="n">teq</span> <span class="o">+=</span> <span class="n">b</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
  <span class="n">teq</span> <span class="o">-=</span> <span class="n">a</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="n">model</span><span class="p">.</span><span class="n">addConstr</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">teq</span><span class="p">);</span>
<span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
    
<span class="c1">// New constraints 2</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">GRBVar</span><span class="o">&gt;</span> <span class="n">y</span><span class="p">(</span><span class="n">n</span><span class="p">);</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
  <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span><span class="p">.</span><span class="n">addVar</span><span class="p">(</span><span class="o">-</span><span class="n">GRB_INFINITY</span><span class="p">,</span> <span class="n">GRB_INFINITY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GRB_CONTINOUS</span><span class="p">);</span>
<span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
  <span class="n">model</span><span class="p">.</span><span class="n">addConstr</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">ahat</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
<span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>

<span class="c1">// The final constraint</span>
<span class="n">GRBQuadExpr</span> <span class="n">lhs</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
  <span class="n">lhs</span> <span class="o">+=</span> <span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">y</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<span class="n">model</span><span class="p">.</span><span class="n">addQConstr</span><span class="p">(</span><span class="n">lhs</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">);</span>
<span class="n">model</span><span class="p">.</span><span class="n">update</span><span class="p">();</span>
</code></pre></div>

</div>

    </div>
    <aside class="four columns">
      <a href="/">Home</a><br><br>
      <h4>Recent Posts</h4>
      <ul style="list-style: none outside;">
        
          <li><a href="/2013/an-icelandic-adventure.html">An Icelandic Adventure</a></li>
        
          <li><a href="/2013/simulation-study-of-a-laundry-room.html">Simulation Study of a Laundry Room</a></li>
        
          <li><a href="/2013/experiences-with-xmonad-and-ubuntu-12.html">Experiences with Setting Up Xmonad on Ubuntu 12</a></li>
        
          <li><a href="/2013/mit-iap-2013.html">MIT IAP 2013</a></li>
        
          <li><a href="/2013/comparing-the-weather-of-different-cities.html">Comparing the Weather of Different Cities</a></li>
        
          <li><a href="/2012/implementing-second-order-cone-constraints-in-gurobi.html">Implementing Second-order Cone Constraints in Gurobi</a></li>
        
      </ul>
    </aside>
    <div class="sixteen columns">
      <hr />
      © 2013 Iain Dunning<br>
      Contact me by email (idunning AT mit DOT edu), <a href="https://www.twitter.com/iaindunning">@iaindunning</a>, <a href="http://www.linkedin.com/in/iaindunning">LinkedIn</a>, <a href="https://github.com/IainNZ">GitHub</a><br>
      This website was made with <a href="http://jekyllrb.com">Jekyll</a> and <a href="http://www.getskeleton.com">Skeleton</a>.
    </div>
  </div><!-- container -->

</body>
</html>
